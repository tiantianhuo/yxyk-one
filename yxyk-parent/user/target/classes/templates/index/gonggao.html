<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>公告设置</title>
    <link rel="stylesheet" href="../../static/vonder/bootstrap-3.3.7-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../static/vonder/bootstrap-table/bootstrap-table.min.css">
    <link rel="stylesheet" href="../../static/vonder/jqueryStep/css/jquery.step.css">
    <link rel="stylesheet" href="../../static/vonder/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="../../static/vonder/font_7grt4on8i7d/iconfont.css" media="all">
    <link rel="stylesheet" href="../../static/css/common.css"/>

    <script src="../../static/vonder/jquery-1.10.2/jquery-1.10.2.min.js"></script>
    <script src="../../static/vonder/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <script src="../../static/vonder/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="../../static/vonder/layui/layui.js"></script>

    <!--gonggao-->
    <link rel="stylesheet" href="../../static/css/commonss.css"/>
    <link rel="stylesheet" href="../../static/css/models.css"/>
    <link rel="stylesheet" href="../../static/css/delete.css"/>
    <link rel="stylesheet" href="../../static/css/index-index.css"/>
    <link rel="stylesheet" href="../../static/css/banner.css"/>
    <link rel="stylesheet" href="../../static/css/affiche.css"/>

    <link rel="stylesheet" type="text/css" href="../../static/css/build.css"/>
    <!-- 图片-->
    <script src="../../static/js/jquery.imgZoom.js"></script>
    <!--富文本-->
    <script src="../../static/vonder/ueditor/ueditor.config.js"></script>
    <script src="../../static/vonder/ueditor/ueditor.all.min.js"></script>
    <script src="../../static/vonder/ueditor/ueditor.all.js"></script>
    <script src="../../static/vonder/ueditor/lang/zh-cn/zh-cn.js"></script>
    <script type="text/javascript" src="../../static/js/commonss.js"></script>
    <script src="../../static/vonder/ueditor/xiumi-ue-dialog-v5.js"></script>

    <style type="text/css">
        .edui-default .edui-dialog{
            top: 70px;
        }
        .edui-button.edui-for-xiumi-connect .edui-button-wrap .edui-button-body .edui-icon {
            background-image: url("http://xiumi.us/connect/ue/xiumi-connect-icon.png") !important;
            background-size: contain;
        }

        .boxs {
            padding-top: 30px;
        }
    </style>

</head>

<body>
<!--头-->
<#include "../common/header.html"/>
<script>
    $(function () {
        $("#li_bgyy").addClass('active')
    });
</script>
<!--头end-->
<div class="wrapper">
    <div class="content content-index">
        <!--右侧开始-->
        <div class="content-right">
            <!--内容-->
            <div>
                <ul class="customer-ul customer-uls">
                    <li>当前位置：首页设置-修改公告</li>
                </ul>
                <div class="customer-box">
                    <div class="fromboxs">
                        <div class="from-left from-lefts ">
                            图&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;片：
                        </div>
                        <div class="from-right from-rights">
                            <div class="layui-upload">
                                <img src="../../static/imgbox/img/upload.png" id="test2"/>
                                <div class="layui-upload-list" id="demo2"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="boxs-left">
                            <div class="fromboxs boxs">
                                <div class="from-left">
                                    名&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;称：
                                </div>
                                <div class="from-right">
                                    <input type="text" placeholder="请输入公告名称" id="book"/>
                                </div>
                            </div>
                            <div class="fromboxs">
                                <div class="from-left">
                                    发&nbsp;&nbsp;布&nbsp;&nbsp;人：
                                </div>
                                <div class="from-right">
                                    <input type="text" placeholder="请填写发布人" id="people"/>
                                </div>
                            </div>
                            <div class="fromboxs">
                                <div class="from-left">
                                    内&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;容：
                                </div>
                                <div class="from-right">
                                    <textarea id="editor" type="text/plain" style="width:90%;height:450px;"></textarea>
                                </div>
                            </div>
                            <div class="click">
                                <button class="btn save" onclick="save()">发布</button>
                                <button class="btn back" onclick="window.location.href='/Index/index?liNumber=1';">返回
                                </button>
                            </div>
                        </div>
                        <!--box-left结束-->

                        <!--box-right开始-->
                        <div class="boxs-right boxs">
                            <p style="margin-left: 13px;">文章预览（预览模式模拟手机型号为iPhone6）</p>
                            <div class="img-content">
                                <div class="contentbox">
                                    <div id="book-a" class="book-a book"></div>
                                    <div id="people-a" class="book-a"></div>
                                    <div id="content-a" class="content-a"></div>
                                </div>

                            </div>
                        </div>
                        <!--boxs内容结束-->
                    </div>
                </div>
                <!--内容结束-->
                <!--分页开始-->
                <div id="demo" class="demo"></div>
            </div>
        </div>
        <#include "/common/footer.html"/>
        <input id="id" value=${id} type="hidden">
    </div>
</div>
</body>

</html>

<script>
    function look(){
        // 上传图片点击放大
        $(".layui-upload-list").find("img").imgZoom();
    }

    //富文本初始化
    let ueditor_config = {
        autoHeightEnabled: false
    };
    var ue = UE.getEditor('editor',ueditor_config);

    //文章标题
    var book = document.getElementById('book');
    var booka = document.getElementById('book-a');
    //发布人
    var people = document.getElementById('people');
    var peoplea = document.getElementById('people-a');
    //内容
    var content = document.getElementById('editor');
    var contenta = document.getElementById('content-a');
    book.onchange = function () {
        booka.innerHTML = book.value;
    };
    people.onchange = function () {
        peoplea.innerHTML = people.value;
    };
    content.onchange = function () {
        contenta.innerHTML = ue.getContent();
    };
    ue.addListener("selectionchange", function () {
        contenta.innerHTML = ue.getContent();

    });
    UE.Editor.prototype._bkGetActionUrl = UE.Editor.prototype.getActionUrl;
    UE.Editor.prototype.getActionUrl = function (action) {
        if (action == 'uploadimage' || action == 'uploadscrawl' || action == 'uploadimage' || action == 'uploadvideo' ) {
            return '/uploadimage';//指定访问路径
        }if (action == 'catchimage'){

        } else {
            return this._bkGetActionUrl.call(this, action);
        }
    }
    var list = [];
    layui.use('upload', function () {
        var $ = layui.jquery,
            upload = layui.upload;

        //图片上传
        upload.render({
            elem: '#test2',
            url: '/banners/uploadBanner',
            before: function (obj) {
                //预读本地文件示例，不支持ie8
                obj.preview(function (index, file, result) {
                    $('#demo2').html('<img src="' + result + '"  onclick=\'look()\' alt="" class="layui-upload-img">')
                });

            },
            done: function (res) {
                //上传完毕
                console.log("图片地址" + res.data);
                list = [];
                list.push(res.data);
            }
        });
    });

    var id;
    $(function () {
        findAffiche();
    });

    function findAffiche() {
        id = $("#id").val();
        $.ajax({
            url: "/apis/affiche/findById",
            type: "post",
            data: {
                "id": id,
            },
            success: function (result) {
                console.log(result);
                var content = result.data.content;
                var title = result.data.title;
                var author = result.data.author;
                var name = result.data.name;
                var path = result.data.path;
                if (result.success) {
                    ue.ready(function () {//编辑器初始化完成再赋值
                        ue.setContent(content);  //赋值给UEditor
                    });
                    if (path != "" && path != null) {
                        $('#demo2').html('<img src="' + path + '"  onclick=\'look()\' alt="" class="layui-upload-img">');
                    }

                    $("#people").val(author);
                    $("#book").val(title);
                    $("#name").val(name);
                    $("input:radio[value='" + result.data.openState + "']").attr('checked', 'true');
                    booka.innerHTML = title;
                    peoplea.innerHTML = author;
                    contenta.innerHTML = content;
                    list.push(result.data.path);

                } else {
                    console.log("查询出错")
                }
            }
        })
    }

    //修改保存
    function save() {
        var content = ue.getContent();
        var author = $("#people").val();
        var title = $("#book").val();
        var path = list.toString();
        //概要 outline
        var outline = ue.getContentTxt();
        if (outline.length > 20) {
            outline = outline.substring(0, 20) + "...";
        }
        if (title == "") {
            return layer.msg("标题不能为空!");
        }
        if (author == "") {
            return layer.msg("作者不能为空!");
        }
        if (content == "") {
            return layer.msg("内容不能为空!");
        }
        if (path == "") {
            return layer.msg("图片不能为空!");
        }
        $.ajax({
            url: "/apis/affiche/updateById",
            type: "post",
            data: {
                "content": content,
                "author": author,
                "title": title,
                "path": path,
                "id": id,
                "outline": outline,
            },
            success: function (result) {
                console.log(result)
                if (result.success) {
                    layer.msg("修改成功!");
                    window.location.href = "/Index/index?liNumber=1";
                } else {
                    layer.msg("修改失败!");
                }
            }
        })

    }
</script>