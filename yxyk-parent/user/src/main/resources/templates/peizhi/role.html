<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>角色管理</title>
    <link rel="stylesheet" href="/vonder/bootstrap-3.3.7-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/vonder/bootstrap-table/bootstrap-table.min.css">
    <link rel="stylesheet" href="/vonder/jqueryStep/css/jquery.step.css">
    <link rel="stylesheet" href="/vonder/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/vonder/font_7grt4on8i7d/iconfont.css" media="all">
    <link rel="stylesheet" href="/css/common.css"/>
    <link rel="stylesheet" href="/css/configure.css"/>
    <link rel="stylesheet" href="/css/PopularOpinion.css"/>
    <link rel="stylesheet" href="/css/pinggu.css"/>
    <link href="/vonder/iCheck/skins/all.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="/css/customer.css">

    <script src="/vonder/jquery-1.10.2/jquery-1.10.2.min.js"></script>
    <script src="/vonder/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <script src="/vonder/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="/vonder/jqueryStep/js/jquery.step.min.js"></script>
    <script src="/vonder/layui/layui.js"></script>
    <script src="/vonder/iCheck/icheck.js"></script>
    <script type="text/javascript" src="/js/common.js"></script>
    <style>
        .contentrights {
            float: none;
        }
    </style>
</head>

<body>
<!--头-->
<#include "../common/header.html"/>
<!--头end-->
<div class="wrapper ">
    <div class="content">
        <#include "../common/public_menu.html"/>
        <div class="contentright contentrights">
            <div class="cookie">
                当前位置：
                <span><a href="">配置管理</a></span>-
                <span><a href="">角色管理</a></span>
            </div>

            <div class="selectbox">
                <div class="layui-inline layui-role">
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input" id="test6" placeholder="请选择时间"
                               style="width:220px;" lay-key="1">
                    </div>
                </div>
                <input type="text" class="form-control inputs" placeholder="请输入角色名搜索" id="roleNames"
                       oninput="findAll(1,10,null)">
                <button class="chongzhi" data-toggle="modal" data-target="#adduser">新建角色
                </button>
            </div>
            <div class="tablebox">
                <table class="table table-bordered mytable">
                    <thead>
                    <tr>
                        <th>序号</th>
                        <th>角色</th>
                        <th>备注</th>
                        <th>创建时间</th>
                        <th style="width:300px;">操作</th>
                    </tr>
                    </thead>
                    <tbody id="tbody">
                    <tr>
                        <td colspan="6" style="line-height: 200px">
                        </td>
                    </tr>
                    </tbody>
                </table>
                <div id="demo7" style="float:right"></div>
            </div>
        </div>
        <#include "/common/footer.html"/>
    </div>

</body>


<!-- 添加模块模态框 -->
<div class="modal fade modal-new results-sentencing" id="adduser" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="closes"><img src="/images/user/close.png" alt="" class="closeimg"></div>
                <p class="addtitle">新建角色</p>
            </div>
            <div class="modal-body">
                <form action="">
                    <div class="passwordtext">
                        <div class="w30">角色名称</div>
                        <div class="w70">
                            <input type="text" id="roleName" class="inputcss" placeholder="请输入角色名称"/>
                        </div>
                    </div>
                    <div class="passwordtext">
                        <div class="w30">备注</div>
                        <div class="w70">
                            <input type="text" id="remarks" class="inputcss" placeholder="请输入备注"/>
                        </div>
                    </div>
                    <div class="btnboxs">
                        <button class="quxiaos" type="button">取消</button>
                        <button class="baocuns" onclick="addRole()">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- 添加模块模态框 结束-->

<!-- 修改模块模态框 -->
<div class="modal fade modal-new results-sentencing" id="edit" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="closes"><img src="/images/user/close.png" alt="" class="closeimg"></div>
                <p class="addtitle">修改角色</p>
            </div>
            <div class="modal-body">
                <form action="">
                    <div class="passwordtext">
                        <div class="w30">角色名称：</div>
                        <div class="w70">
                            <input type="text" class="inputcss" placeholder="请输入角色名称" id="editRoleName"/>
                        </div>
                    </div>
                    <div class="passwordtext">
                        <div class="w30">备注：</div>
                        <div class="w70">
                            <input type="text" class="inputcss" placeholder="请输入备注" id="editRemarks"/>
                        </div>
                    </div>
                    <div class="btnboxs">
                        <button class="quxiaos" type="button">取消</button>
                        <button class="baocuns" onclick="saveRole()">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- 修改模块模态框 结束-->

<!--权限模态框开始-->
<div class="modal fade bs-example-modal-lg" id="rolemodal" tabindex="-1" role="dialog"
     aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="closes"><img src="/images/user/close.png" alt="" class="closeimg"></div>
                <p class="addtitle">权限管理</p>
            </div>
            <div class="modal-body">
                <form action="">
                    <div class="power">
                        <div class="powerL">页面</div>
                        <div class="powerR">权限配置</div>
                    </div>
                    <@shiro.hasAnyPermissions name="10101,10102">
                    <div class="power">
                        <div class="powerL bortop">群众举报</div>
                        <div class="powerRtwo bortop">
                            <@shiro.hasAnyPermissions name="10101">
                            <input type="checkbox" name="tipOff" permissions="permissions" value="10101"/>查看
                        </@shiro.hasAnyPermissions>
                        <@shiro.hasAnyPermissions name="10102">
                        <input type="checkbox" name="tipOff" permissions="permissions" value="10102"/>办理
                    </@shiro.hasAnyPermissions>
            </div>
        </div>
    </@shiro.hasAnyPermissions>
    <@shiro.hasAnyPermissions name="10201,10202">
    <div class="power">
        <div class="powerL bortop">线索核查</div>
        <div class="powerRtwo bortop">
            <@shiro.hasAnyPermissions name="10201">
            <input type="checkbox" name="check" permissions="permissions" value="10201"/>查看
        </@shiro.hasAnyPermissions>
        <@shiro.hasAnyPermissions name="10202">
        <input type="checkbox" name="check" permissions="permissions" value="10202"/>办理
    </@shiro.hasAnyPermissions>
</div>
</div>
</@shiro.hasAnyPermissions>
<@shiro.hasAnyPermissions name="10301">
<div class="power">
    <div class="powerL bortop">数据统计</div>
    <div class="powerRtwo bortop">
        <input type="checkbox" name="statistics" permissions="permissions" value="10301"/>查看
    </div>
</div>
</@shiro.hasAnyPermissions>
<@shiro.hasAnyPermissions name="10401,10402,10408,10403">
<div class="power">
    <div class="powerL bortop">小程序管理</div>
    <div class="powerRtwo bortop">
        <@shiro.hasAnyPermissions name="10401">
        <input type="checkbox" name="applet" permissions="permissions" value="10401"/>banner设置
    </@shiro.hasAnyPermissions>
    <@shiro.hasAnyPermissions name="10402">
    <input type="checkbox" name="applet" permissions="permissions" value="10402"/>公告设置
</@shiro.hasAnyPermissions>
<@shiro.hasAnyPermissions name="10408">
<input type="checkbox" name="applet" permissions="permissions" value="10408"/>举报指引设置
</@shiro.hasAnyPermissions>
</div>
</div>
</@shiro.hasAnyPermissions>
<@shiro.hasAnyPermissions name="10404,10405">
<div class="power">
    <div class="powerL bortop">舆情专报</div>
    <div class="powerRtwo bortop">
        <@shiro.hasAnyPermissions name="10404">
        <input type="checkbox" name="report" permissions="permissions" value="10404"/>查看
    </@shiro.hasAnyPermissions>
    <@shiro.hasAnyPermissions name="10405">
    <input type="checkbox" name="report" permissions="permissions" value="10405"/>管理(上传和删除)
</@shiro.hasAnyPermissions>
</div>
</div>
</@shiro.hasAnyPermissions>
<@shiro.hasAnyPermissions name="10406">
<div class="power">
    <div class="powerL bortop">法律法规</div>
    <div class="powerRtwo bortop">
        <input type="checkbox" name="law" permissions="permissions" value="10406"/>查看
    </div>
</div>
</@shiro.hasAnyPermissions>
<@shiro.hasAnyPermissions name="10407">
<div class="power">
    <div class="powerL bortop">案例库</div>
    <div class="powerRtwo bortop">
        <input type="checkbox" name="library" permissions="permissions" value="10407"/>查看
    </div>
</div>
</@shiro.hasAnyPermissions>
<@shiro.hasAnyPermissions name="10501,10502">
<div class="power">
    <div class="powerL bortop">配置管理</div>
    <div class="powerRtwo bortop">
        <@shiro.hasAnyPermissions name="10501">
        <input type="checkbox" name="deploy" permissions="permissions" value="10501"/>用户管理
    </@shiro.hasAnyPermissions>
    <@shiro.hasAnyPermissions name="10502">
    <input type="checkbox" name="deploy" permissions="permissions" value="10502"/>角色管理
</@shiro.hasAnyPermissions>
</div>
</div>
</@shiro.hasAnyPermissions>
<@shiro.hasAnyPermissions name="10601">
<div class="power">
    <div class="powerL bortop">个人中心</div>
    <div class="powerRtwo bortop">
        <input type="checkbox" name="person" permissions="permissions" value="10601"/>修改密码
    </div>
</div>
</@shiro.hasAnyPermissions>
<div class="btnboxs">
    <button class="quxiaos" type="button">取消</button>
    <button class="baocuns" type="button" onclick="savePermission()">保存</button>
</div>
</form>
</div>
</div>
</div>
<!--权限模态框结束-->
</body>
</html>
<script>
    $("#jsgl").attr("class",$("#jsgl").attr("class")+" actives");

    /*icheck*/
    $('input').iCheck({
        checkboxClass: 'icheckbox_minimal-blue',
        radioClass: 'iradio_minimal-blue',
        increaseArea: '20%' // optional
    });
    /*时间插件*/
    layui.use('laydate', function () {
        var laydate = layui.laydate;

        //常规用法
        laydate.render({
            elem: '#test1'
            , theme: '#3299fe'
        });

        laydate.render({
            elem: '#test1s'
            , theme: '#3299fe'
        });


    });
    /*分页*/
    layui.use(['laypage', 'layer'], function () {
        var laypage = layui.laypage
            , layer = layui.layer;
        //完整功能
        laypage.render({
            elem: 'demo7'
            , count: 100
            , layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip']
            , jump: function (obj) {
                console.log(obj)
            }
        });

    });
    /*icheck*/
    $('input').iCheck({
        checkboxClass: 'icheckbox_minimal-blue',
        radioClass: 'iradio_minimal-blue',
        increaseArea: '20%' // optional
    });
    $(".closeimg").click(function () {
        $("#adduser").modal('hide');  //手动关闭
        $("#edit").modal('hide');  //手动关闭
        $("#rolemodal").modal('hide');  //手动关闭
        clearForm("#adduser");
        clearForm("#edit");
        clearForm("#rolemodal");
    })
    $(".quxiaos").click(function () {
        $("#adduser").modal('hide');  //手动关闭
        $("#edit").modal('hide');  //手动关闭
        $("#rolemodal").modal('hide');  //手动关闭
        clearForm("#adduser");
        clearForm("#edit");
        clearForm("#rolemodal");
    })
    layui.use('layer', function () {
        layer = layui.layer;
    });
    /*时间插件*/
    layui.use('laydate', function () {
        var laydate = layui.laydate;
        //日期范围
        laydate.render({
            elem: '#test6'
            , theme: '#3299fe'
            , range: '~'
            , done: function (value, date, endDate) {
                if (value == "") {
                    findAll(1, 10, null);
                } else {
                    findAll(1, 10, value);
                }
            }
        });
    });
    var roleId;
    $(function () {
        findAll(1, 10, null);
    });

    // 查询所有角色
    function findAll(curr, limit, time) {
        var roleName = $("#roleNames").val();
        var t = $("#test6").val();
        if (t != '') {
            time = t;
        }
        if (time != null && time != "") {
            var times = time.split(" ");
            var startTime = times[0] + ' 00:00:00';
            var endTime = times[2] + ' 23:59:59';
        }


        $.ajax({
            url: "/apis/role/findAllRoleName",
            type: "post",
            data: {
                "startTime": startTime,
                "endTime": endTime,
                "pageNum": curr,
                "pageSize": limit,
                "roleName": roleName
            },
            success: function (result) {
                console.log(result);
                if (result.success) {
                    var data = result.data;
                    if (data.list.length != 0) {
                        // 序号
                        var number = (curr - 1) * limit;
                        var str = '';
                        $(data.list).each(function (i, obj) {
                            number++;
                            var remarks = '--';
                            if (obj.remarks != null) {
                                remarks = obj.remarks;
                            }

                            str +=
                                '<tr>' +
                                '<td>' + number + '</td>' +
                                '<td>' + obj.roleName + '</td>' +
                                '<td>' + remarks + '</td>' +
                                '<td>' + obj.createTime + '</td>\n' +
                                '<td>' +
                                '<span class="del" class="chongzhi" data-toggle="modal" data-target=".new" onclick="updateRole(' + obj.id + ')">修改</span>' +
                                "<span class='del power' data-toggle='modal' data-target='.bs-example-modal-lg' onclick='echoPermission(" + JSON.stringify(obj) + ")'>权限</span>" +
                                '<span class="del" onclick="delRole(' + obj.id + ')">删除</span>' +
                                '</td>' +
                                '</tr>';
                        });
                        $("#tbody").html(str);
                        // 大于10条显示 分页
                        if (result.total > limit) {
                            $("#demo7").show();
                            page(result.total, curr, limit);
                        } else {
                            $("#demo7").hide();
                        }
                    } else {
                        $("#demo7").hide();
                        // 无数据展示图片
                        $("#tbody").html('<td colspan="5"><img src="/static/common/noneDate.png" style="width: 123px;margin:50px 0;"></td>');
                    }
                } else {
                    console.log(result.msg);
                    $("#demo7").hide();
                    // 无数据展示图片
                    $("#tbody").html('<td colspan="5"><img src="/static/common/noneDate.png" style="width: 123px;margin:50px 0;"></td>');
                }

            }
        })
    }


    // 回显修改角色
    function updateRole(id) {
        roleId = id;
        $.ajax({
            url: "/apis/role/findRoleById",
            type: "post",
            data: {
                id: id
            },
            success: function (result) {
                $("#edit").modal();
                if (result.success) {
                    roleId = result.data.id;
                    $("#editRoleName").val(result.data.roleName);
                    $("#editRemarks").val(result.data.remarks);
                } else {
                    console.log("查询出错")
                }
            }
        })
    }

    //保存修改角色
    function saveRole() {
        var roleName = $("#editRoleName").val();
        var remarks = $("#editRemarks").val();
        if (roleName == '') {
            return layer.msg('角色名称不能为空');
        }
        $.ajax({
            url: "/apis/role/updateRole",
            type: "post",
            data: {
                id: roleId,
                roleName: roleName,
                remarks: remarks
            },
            success: function (result) {
                console.log(result)
                $("#edit").modal('hide');
                findAll(1, 10, null);
            }
        })
    }

    // 删除角色
    function delRole(id) {
        layer.confirm("确定要删除权限吗?", {skin: 'demo-class'}, function () {
            $.ajax({
                url: "/apis/role/deleteRoleById",
                type: "post",
                data: {
                    id: id
                },
                success: function (result) {
                    console.log(result);
                    if (result.success) {
                        layer.closeAll('dialog'); //关闭信息框
                        findAll(1, 10, null);
                    } else {
                        layer.msg(result.msg);
                    }
                }
            })
        });
    }

    //添加角色
    function addRole() {
        var roleName = $("#roleName").val();
        var remarks = $("#remarks").val();

        if (roleName === '') {
            return layer.msg('角色名称不能为空');
        }
        $.ajax({
            url: "/apis/role/addRole",
            type: "post",
            data: {
                roleName: roleName,
                remarks: remarks
            },
            success: function (result) {
                console.log(result);
                if (result.success) {
                    layer.closeAll('dialog'); //关闭信息框
                    findAll(1, 10, null);
                } else {
                    layer.msg(result.msg);
                }
            }
        })
    }

    //回显权限
    function echoPermission(obj) {
        var permissions = obj.permissions;
        roleId = obj.id;
        // 进入方法就把input的勾选全部取消掉
        $("input[permissions='permissions']").iCheck('uncheck');
        if (permissions != null && permissions !== '') {
            $(permissions.split(",")).each(function (i, obj) {
                if (obj !== "") {
                    $("input[permissions='permissions'][value=" + obj + "]").iCheck('check');
                }
            })
        }
    }

    // 修改权限
    function savePermission() {
        var permission = '';
        $("input[permissions='permissions']:checked").each(function (i, obj) {
            permission += obj.value + ',';
        });
        $.ajax({
            url: "/apis/role/savePermission",
            type: "post",
            data: {
                id: roleId,
                permission: permission
            },
            success: function (result) {
                $("#rolemodal").modal('hide');
                findAll(1, 10, null);
            }
        });
    }

    //清空表格
    function clearForm(form) {
        $(':input', form).each(function () {
            var type = this.type;
            var tag = this.tagName.toLowerCase();
            if (type === 'text' || type === 'password' || tag === 'textarea')
                this.value = "";
            else if (tag === 'select')
                this.selectedIndex = 0;
        });
    };
</script>